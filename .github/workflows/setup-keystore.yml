name: Setup Android Keystore

on:
  workflow_dispatch:

jobs:
  generate-keystore:
    runs-on: ubuntu-latest
    steps:
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Generate Keystore
        run: |
          keytool -genkey -v -keystore my-upload-key.keystore -alias my-key-alias -keyalg RSA -keysize 2048 -validity 10000 -storepass android -keypass android -dname "CN=ListApp User, OU=ListApp, O=Personal, L=Unknown, S=Unknown, C=US"
          
          echo "::notice title=Keystore Generated::Keystore generated successfully."

      - name: Get SHA-1 Fingerprint
        run: |
          SHA1=$(keytool -list -v -keystore my-upload-key.keystore -alias my-key-alias -storepass android | grep "SHA1:")
          echo "::notice title=SHA-1 Fingerprint::$SHA1"
          echo "SHA-1 Fingerprint: $SHA1"

      - name: Encode Keystore to Base64
        id: encode
        run: |
          BASE64_KEYSTORE=$(base64 -w 0 my-upload-key.keystore)
          echo "::add-mask::$BASE64_KEYSTORE"
          echo "base64_keystore=$BASE64_KEYSTORE" >> $GITHUB_OUTPUT
          
          # Print it in chunks so it doesn't get masked if we want the user to see it (Github masks secrets, but this is a new secret)
          # Actually, we want the user to SEE it to copy it.
          # GitHub Actions might mask it if it looks like a secret? No, only if it's in the secrets store.
          
          echo "-------------------------------------------------------"
          echo "COPY THE TEXT BELOW FOR YOUR GITHUB SECRET (ANDROID_KEYSTORE_BASE64)"
          echo "-------------------------------------------------------"
          echo "$BASE64_KEYSTORE"
          echo "-------------------------------------------------------"

      - name: Save Secrets to File
        run: |
          echo "ANDROID_KEYSTORE_BASE64=$BASE64_KEYSTORE" >> secrets.txt
          echo "ANDROID_KEYSTORE_PASSWORD=android" >> secrets.txt
          echo "ANDROID_KEY_ALIAS=my-key-alias" >> secrets.txt
          echo "ANDROID_KEY_PASSWORD=android" >> secrets.txt
          echo "SHA-1 Fingerprint: $SHA1" >> secrets.txt

      - name: Upload Keystore and Secrets
        uses: actions/upload-artifact@v3
        with:
          name: keystore-and-secrets
          path: |
            secrets.txt
            my-upload-key.keystore
